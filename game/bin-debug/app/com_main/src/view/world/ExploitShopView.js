var __extends = (this && this.__extends) || (function () {
    var extendStatics = function (d, b) {
        extendStatics = Object.setPrototypeOf ||
            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
        return extendStatics(d, b);
    };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var com_main;
(function (com_main) {
    /**
     * 战功商城
     */
    var ExploitShopView = /** @class */ (function (_super_1) {
        __extends(ExploitShopView, _super_1);
        function ExploitShopView(width, height) {
            var _this = _super_1.call(this) || this;
            _this.m_pWidgets = {};
            _this.m_curIndex = 0;
            _this.m_curInfo = null; //当前数据
            _this.m_curTime = 0;
            _this.m_coinId = 0; //消耗的货币Id
            _this.m_numMax = 0; //消耗的货币数量
            _this.currState = 0; //当前选择按钮类型
            _this.m_pRemainTime = 0;
            _this.name = ExploitShopView.NAME;
            _this.initApp("world/ExploitShopViewSkin.exml");
            return _this;
            // this.width = width;
            // this.height = height;
        }
        ExploitShopView.prototype.$onRemoveFromStage = function (isclear) {
            if (isclear === void 0) { isclear = true; }
            this.onDestroy();
            _super_1.prototype.$onRemoveFromStage.call(this, isclear);
        };
        ExploitShopView.prototype.onDestroy = function () {
            _super_1.prototype.onDestroy.call(this);
            com_main.EventMgr.removeEventByObject(RoleEvent.ROLE_RESOURCE, this);
            this.m_List.removeEventListener(eui.ItemTapEvent.ITEM_TAP, this.onTouchTab, this);
            Utils.TimerManager.remove(this.updateRemainTime, this);
        };
        ExploitShopView.prototype.childrenCreated = function () {
            _super_1.prototype.childrenCreated.call(this);
            // this.height = this.stage.stageHeight;
            Utils.toStageBestScaleHeigt(this);
            // 初始化界面
            ShopProxy.send_GET_MERCHANT(ShopStoreIdEnum.EXPLOIT);
            // this.initView(this.m_curInfo);
        };
        ExploitShopView.prototype.onClickBack = function () {
            com_main.UpManager.history();
        };
        ExploitShopView.prototype.initView = function (data) {
            this.refreshData(data);
            this.updateExploitLab(PropEnum.MILITARY_MERITS_CONSUMED);
            com_main.EventMgr.addEvent(RoleEvent.ROLE_RESOURCE, this.updateExploitLab, this);
            this.m_List.addEventListener(eui.ItemTapEvent.ITEM_TAP, this.onTouchTab, this);
        };
        ExploitShopView.prototype.refreshData = function (data) {
            this.labRefresh();
            var res = [];
            for (var i = 0; i < data.goods.length; i++) {
                res.push({ storeId: ShopStoreIdEnum.EXPLOIT, info: data.goods[i] });
            }
            if (this.m_pListDataProvider) {
                this.m_pListDataProvider.replaceAll(res);
            }
            else {
                this.m_pListDataProvider = new eui.ArrayCollection(res);
                this.m_List.dataProvider = this.m_pListDataProvider;
                this.m_List.itemRenderer = com_main.ShopTreasureCell;
            }
            var Refresh = this.m_curInfo.autoRefresh;
            if (Refresh.length <= 0) { //是否自动刷新
                return;
            }
            var timeArr = [];
            for (var i in Refresh) {
                var h = Refresh[i].key, m = Refresh[i].value;
                var date = new Date(TimerUtils.getServerTimeMill());
                date.setHours(h, m, 0, 0);
                timeArr.push(date.getTime());
            }
            var nowTime = TimerUtils.getServerTimeMill();
            // this.m_labReset.textFlow = Utils.htmlParser(GCodeFromat(CLEnum.SHOP_RUSH_RESET, this.resetTime));
            for (var i = 1; i < timeArr.length; i++) {
                var curIndex = i;
                var preValue = timeArr[i - 1];
                var curValue = timeArr[i];
                if (nowTime > preValue && nowTime < curValue) {
                    console.log('nowTime0=', curValue);
                    this.m_curTime = curValue;
                    break;
                }
                else if (nowTime > curValue && curIndex == timeArr.length - 1) {
                    console.log('nowTime1=', timeArr[0]);
                    this.m_curTime = timeArr[0];
                    break;
                }
                else if (nowTime < preValue) {
                    this.m_curTime = preValue;
                    break;
                }
            }
            this.m_refreshTime.textFlow = Utils.htmlParser(GCodeFromat(CLEnum.SHOP_RUSH_DES, TimerUtils.dateFormat("hh:mm:ss", this.m_curTime / 1000)));
        };
        /**战功商城重置时间 */
        ExploitShopView.prototype.labRefresh = function () {
            this.m_labReset.textFlow = Utils.htmlParser(GCode(CLEnum.EXPLOIT_TIPS));
        };
        /**
         * 更新军功显示
         *
         */
        ExploitShopView.prototype.updateExploitLab = function (itemId) {
            if (itemId != PropEnum.MILITARY_MERITS_CONSUMED)
                return;
            this.m_pExploit.text = "" + RoleData.militaryCoin;
        };
        ExploitShopView.prototype.onTouchTab = function (e) {
            var item = e.item;
            this.m_pWidgets[item.itemId] = e.itemRenderer;
        };
        ExploitShopView.prototype.updateRemainTime = function () {
            var time = Math.floor((TimerUtils.getServerTimeMill() - this.m_curTime) / 1000);
            if (time == 0 || time == 1) {
                Utils.TimerManager.remove(this.updateRemainTime, this);
                var storeId = com_main.ShopTreasure.STORE_LIST[this.m_curIndex];
                ShopProxy.send_GET_MERCHANT(storeId);
            }
        };
        ExploitShopView.prototype.listenerProtoNotifications = function () {
            return [
                ProtoDef.GET_MERCHANT,
                ProtoDef.MERCHANT_BUY_GOODS,
            ];
        };
        /**处理协议号事件 */
        ExploitShopView.prototype.executes = function (notification) {
            var body = notification.getBody();
            var protocol = Number(notification.getName());
            switch (protocol) {
                case ProtoDef.GET_MERCHANT: { // 获得商城信息
                    if (body) {
                        this.m_curInfo = body.info;
                        this.initView(body.info);
                    }
                    break;
                }
                case ProtoDef.MERCHANT_BUY_GOODS: { // 商城购买物品
                    var data = body;
                    if (data) {
                        //刷新商品
                        for (var i = 0; i < this.m_pListDataProvider.source.length; i++) {
                            var item = this.m_pListDataProvider.getItemAt(i);
                            if (item.info.id == data.goodsInfo.id) {
                                var tmp = { storeId: ShopStoreIdEnum.EXPLOIT, info: data.goodsInfo };
                                this.m_pListDataProvider.replaceItemAt(tmp, i);
                                break;
                            }
                        }
                    }
                    break;
                }
            }
        };
        ExploitShopView.NAME = 'ExploitShopView';
        return ExploitShopView;
    }(com_main.CView));
    com_main.ExploitShopView = ExploitShopView;
})(com_main || (com_main = {}));
