module com_main {


	/**
	 * 战功系统主界面
	 */
    export class ExploitMainWnd extends CView {
        public static NAME = 'ExploitMainWnd';

        public m_pCDTtime: com_main.CLabel;
        private m_MainTopNew: MainTopNew;    //标题
        private m_comTabGroup: ComTabGroup;
        private m_tabViewStack: eui.ViewStack;   //主切卡
        private m_tViews: any[] = [];

        private m_curIndex = 0;
        private m_tabData: { [name: string]: { tag: number, id: number } };


        private m_resetTime: number = 0;
        public constructor() {
            super();
            this.name = ExploitMainWnd.NAME;
            this.initApp("world/ExploitMainWndSkin.exml");
        }
        protected listenerProtoNotifications(): any[] {
            return [
                ProtoDef.S2C_RANK_COMM,
            ];
        }

        protected executes(notification: AGame.INotification) {
            let body = notification.getBody();
            let protocol: number = Number(notification.getName());
            switch (protocol) {
                case ProtoDef.S2C_RANK_COMM: {
                    this.m_tViews[1].Refresh();
                    break;
                }
            }
        }
        public onDestroy(): void {
            super.onDestroy();
            RankModel.clear();
            this.m_tViews = null;
            EventManager.removeEventListeners(this);
            Utils.TimerManager.remove(this.updateCDTime, this);
        }

        protected childrenCreated(): void {
            super.childrenCreated();
            this.m_MainTopNew.setTitleName(GCode(CLEnum.EXPLOIT));

            this.m_tabData = {};
            this.m_tabData[GCode(CLEnum.EXPLOIT_TAB_GZ)] = { tag: 0, id: 0 };
            this.m_tabData[GCode(CLEnum.EXPLOIT_TAB_PM)] = { tag: 1, id: 1 }
            this.m_tabData[GCode(CLEnum.EXPLOIT_TAB_ZG)] = { tag: 2, id: 2 }
            this.refreshTabBtns();
            this.m_comTabGroup.setChangeCallback(this.changeTag, this);
            // Utils.toStageBestScale(this.m_tabViewStack);
            this.validateNow();
            let width = this.m_tabViewStack.width;
            let height = this.m_tabViewStack.height;



            let exploitAwardView = new ExploitAwardView(width, height);
            this.m_tabViewStack.addChild(exploitAwardView);

            let exploitRankAwardView = new ExploitRankAwardView(width, height);
            this.m_tabViewStack.addChild(exploitRankAwardView);

            let exploitShopView = new ExploitShopView(width, height);
            this.m_tabViewStack.addChild(exploitShopView);



            this.m_tViews.push(exploitAwardView);
            this.m_tViews.push(exploitRankAwardView);
            this.m_tViews.push(exploitShopView);

            this.validateNow();

            this.initView(this.m_curIndex);



            this.calcuResetTime();
            this.updateCDTime();
            Utils.TimerManager.doTimer(60000, 0, this.updateCDTime, this);

            let container = <egret.DisplayObjectContainer>this.m_comTabGroup.getTabBtnByName(GCode(CLEnum.EXPLOIT_TAB_GZ));
            RedPointModel.AddInfoListener(container, { x: 132, y: -5 }, [RedEvtType.EXPLOIT], 2);


        }
        public calcuResetTime() {
            let curtime = TimerUtils.getServerTimeMill();
            let resetDate = new Date(curtime)
            let cur: Date = new Date(curtime)
            cur.setHours(5)
            cur.setMinutes(0)
            cur.setSeconds(0);
            let day: number = cur.getDay();
            day = day == 0 ? 7 : day;
            //周一凌晨5点
            this.m_resetTime = cur.getTime() + (8 - day) * 3600 * 24 * 1000;
            if (day == 1 && resetDate.getHours() < 5) {
                this.m_resetTime = cur.getTime()
            }
        }
        private changeTag(selIndex: number) {
            this.m_curIndex = selIndex;
            this.initView(selIndex);
        }

        /**刷新切卡 */
        private refreshTabBtns() {
            this.m_comTabGroup.clearTabBtn();
            let tags = [GCode(CLEnum.EXPLOIT_TAB_GZ), GCode(CLEnum.EXPLOIT_TAB_PM), GCode(CLEnum.EXPLOIT_TAB_ZG)];
            this.m_comTabGroup.initNorTabBtns(tags);
        }


        private initView(tag) {
            this.m_comTabGroup.selectedIndex = tag;
            let name = this.m_comTabGroup.selName;
            let data = this.m_tabData[name];
            if (!data)
                return;
            if (tag == 1) {
                //请求战力奖励数据
                RankProxy.C2S_RANK_COMM(RankType.MILLTORY)
            }
            this.m_tabViewStack.selectedIndex = data.tag;
        }
        /**
         * 更新倒计时时间
         */
        public updateCDTime() {
            let curtime = TimerUtils.getServerTimeMill();
            let str = Utils.DateUtils.getCountdownStrByCfg(this.m_resetTime - curtime, 1);
            this.m_pCDTtime.text = str;
        }

    }

}